

# 使用 Layer API 进行形状变换

## 概述

本示例使用 [示例 07](../07_creating_a_model_with_the_layer_api/) 中的 Layer API **构建了一个能够对动态形状输入进行形状操作的模型**。

具体包括以下两种常见操作：

1. 对动态形状的输入张量进行展平。涉及的步骤：
    - 使用 `Shape` 获取输入张量的形状。
    - 使用 `ReduceProd` 计算输入形状的体积（所有维度的乘积）。
    - 使用 `Reshape` 将输入重新调整为计算出的体积大小。

2. 压缩输入张量的部分维度。涉及的步骤：
    - 使用 `Shape` 获取输入的形状。
    - 使用 `Gather` 提取输入形状的前 2 个维度。
    - 使用 `Gather` 提取输入形状的最后 2 个维度。
    - 使用 `ReduceProd` 计算最后 2 个维度的乘积。
    - 使用 `Concat` 将原始形状的前几个维度与压缩后的维度组合起来。
    - 使用 `Reshape` 重新调整输入形状。

在深度学习和数据处理中，`ReduceProd` 和 `Gather` 操作非常关键，`ReduceProd` 用于计算乘积以简化数据，`Gather` 用于基于索引重新组织数据，这两者在许多应用场景中都有广泛用途。

## 示例运行步骤

1. 通过以下命令生成模型，并将其保存为 `model.onnx`：
    ```bash
    python3 generate.py
    ```

    生成的模型结构如下：

    ![../resources/09_model.onnx.png](../resources/09_model.onnx.png)

`ReduceProd`和`Gather`算子在深度学习和数据处理中扮演重要角色，分别提供了乘法归约和基于索引的数据选取功能。`ReduceProd`通过计算乘积来简化数据，而`Gather`则允许复杂的基于索引的数据重组，这两种操作在不同的场景下都非常有用。

## Running the example

1. Generate the model and save it to `model.onnx` by running:
    ```bash
    python3 generate.py
    ```

    The generated model will look like this:

    ![../resources/09_model.onnx.png](../resources/09_model.onnx.png)

## ReduceProd

`ReduceProd`是一个常见的数学操作，在深度学习框架和数值计算库中广泛使用。它计算输入张量（tensor）沿指定轴（axes）的元素乘积。这个操作对于各种数学和机器学习任务非常有用，比如在某些特定的统计计算或者乘积池化层（product pooling layers）中。下面是关于`ReduceProd`算子的更详细说明：

### 参数

- **输入张量**：`ReduceProd`作用的对象。它可以是任何形状和大小的张量。

- **轴（axes）**：一个整数或整数列表，指定要在其中进行乘积运算的维度。例如，如果输入是二维张量，指定轴为0将沿着列计算乘积，指定轴为1将沿着行计算乘积。如果不指定轴，则默认对整个张量进行操作。

- **keepdims**：一个布尔值，用于指示在输出张量中是否保持被缩减的维度。如果`keepdims`等于1，那么输出张量将保持与输入张量相同的秩（维度数量），被缩减的维度将以大小为1的维度出现在结果中。如果`keepdims`等于0，那么被缩减的维度将从输出张量中删除，导致输出张量的秩减少。

### 具体作用

- **元素乘积**：`ReduceProd`计算输入张量中所有指定轴上的元素乘积。例如，如果输入是一个形状为`(3, 4)`的二维张量，指定轴为1，则会计算每一行的所有元素的乘积，得到一个形状为`(3,)`的一维张量（如果`keepdims=0`）或形状为`(3, 1)`的二维张量（如果`keepdims=1`）。

- **空值集的处理**：如果对一个空的张量或指定的轴上没有元素进行`ReduceProd`操作，结果将定义为1，这是乘积操作的恒等元素。

### 使用场景举例

假设你有一个形状为`(2, 3)`的张量，内容如下：

```
[[1, 2, 3],
 [4, 5, 6]]
```

如果你对这个张量应用`ReduceProd`操作，指定轴为1（沿着行进行乘积），结果将是每行元素的乘积：

- 不保持维度（`keepdims=0`）：结果是一个形状为`(2,)`的张量，内容为`[6, 120]`，因为`1*2*3=6`且`4*5*6=120`。
- 保持维度（`keepdims=1`）：结果是一个形状为`(2, 1)`的张量，内容为`[[6], [120]]`。

`ReduceProd`是一个非常强大的算子，可以用于多种复杂的数学和机器学习操作中，包括但不限于几何平均的计算、某些特殊类型的归一化处理，或者在处理概率乘积时。



