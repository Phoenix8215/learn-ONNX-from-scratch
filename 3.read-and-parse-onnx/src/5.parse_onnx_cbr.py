import torch
import torch.nn as nn
import torch.onnx
import onnx
from parserX import parse_onnx
from parserX import read_weight

class Model(torch.nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(in_channels=3, out_channels=16, kernel_size=3)
        self.bn1   = nn.BatchNorm2d(num_features=16)
        self.act1  = nn.LeakyReLU()
    
    def forward(self, x):
        x = self.conv1(x)
        x = self.bn1(x)
        x = self.act1(x)
        return x


def export_norm_onnx():
    input   = torch.rand(1, 3, 5, 5)
    model   = Model()
    model.eval()

    file    = "sample-cbr.onnx"
    torch.onnx.export(
        model         = model, 
        args          = (input,),
        f             = file,
        input_names   = ["input0"],
        output_names  = ["output0"],
        opset_version = 15)
    print("Finished normal onnx export")

def main():
    export_norm_onnx()
    model = onnx.load_model("sample-cbr.onnx")
    parse_onnx(model)

    initializers = model.graph.initializer
    for item in initializers:
        read_weight(item)


if __name__ == "__main__":
    main()

"""
**************parse input/output*****************
Input info:
        name:      input0
        data Type: 1
        shape:     [1, 3, 5, 5]
Output info:
        name:      input0
        data Type: 1
        shape:     [1, 3, 5, 5]

**************parse node************************
node info:
        name:      /conv1/Conv
        op_type:   Conv
        inputs:    ['input0', 'onnx::Conv_12', 'onnx::Conv_13']
        outputs:   ['/conv1/Conv_output_0']
node info:
        name:      /act1/LeakyRelu
        op_type:   LeakyRelu
        inputs:    ['/conv1/Conv_output_0']
        outputs:   ['output0']

**************parse initializer*****************
initializer info:
        name:      onnx::Conv_12
        data_type: 1
        shape:     [16, 3, 3, 3]
initializer info:
        name:      onnx::Conv_13
        data_type: 1
        shape:     [16]

**************parse weight data******************
initializer info:
        name:      onnx::Conv_12
        data:
[[[[ 1.55113563e-01 -1.05398960e-01  1.90794721e-01]
   [ 2.39993166e-02  1.77408949e-01  1.43942818e-01]
   [-2.08649933e-02 -2.51055453e-02  1.17516749e-01]]

  [[-1.65282041e-01 -1.53142571e-01 -1.43425927e-01]
   [-8.96370560e-02 -1.79347247e-01 -1.66230664e-01]
   [ 5.95123321e-02 -1.06699705e-01  1.88134581e-01]]

  [[ 7.87416771e-02 -4.00101319e-02 -6.52103126e-02]
   [ 3.64771150e-02  3.65815721e-02  8.50794986e-02]
   [ 1.63859501e-02  1.44384503e-01 -1.38378203e-01]]]


 [[[ 1.15588546e-01  1.15174808e-01  6.59972103e-03]
   [ 3.00651323e-02  7.44027793e-02 -8.32890347e-02]
   [ 1.03424877e-01  1.88018054e-01  9.51509327e-02]]

  [[ 7.70692676e-02 -1.46896496e-01 -3.39963823e-03]
   [-6.78710416e-02  8.11496302e-02  9.32672843e-02]
   [ 5.33116166e-04 -9.36753675e-02 -8.75083581e-02]]

  [[ 2.75165103e-02  6.38717636e-02  8.85284767e-02]
   [-5.36752194e-02  4.61223200e-02 -1.14909798e-01]
   [-1.35184646e-01  9.67049971e-02  7.18777925e-02]]]


 [[[-8.56515691e-02  3.53714079e-02 -1.46501213e-01]
   [-1.75709218e-01 -7.50338733e-02  1.52258962e-01]
   [-1.21268719e-01  1.17138647e-01 -1.61213532e-01]]

  [[ 1.00851610e-01 -6.44020513e-02 -3.83332968e-02]
   [ 1.63499027e-01 -1.13003105e-01  1.54219761e-01]
   [-1.59918949e-01 -1.21335313e-01  1.28861172e-02]]

  [[ 1.36811450e-01  1.17976330e-01  1.60222068e-01]
   [ 8.74660835e-02 -1.53878048e-01  3.93598340e-02]
   [-9.61477533e-02  1.66264012e-01  8.88616890e-02]]]


 [[[ 6.88074529e-02 -8.31616819e-02  9.02307704e-02]
   [ 7.85330310e-02  1.66829452e-01 -1.67883039e-01]
   [-5.32555133e-02  4.58333418e-02 -1.87526286e-01]]

  [[-9.54818446e-03 -1.95286646e-02 -8.16390440e-02]
   [ 1.47812814e-03 -1.49965242e-01 -1.22316763e-01]
   [ 9.64496806e-02  1.31208822e-01 -1.83798149e-01]]

  [[-1.14751868e-01 -1.21684529e-01 -1.76668271e-01]
   [ 3.34496759e-02 -1.34376690e-01  1.79669783e-01]
   [ 9.38266143e-02 -8.43143165e-02 -1.86809540e-01]]]


 [[[ 2.41558384e-02 -5.69610409e-02  6.57578977e-03]
   [-8.14561471e-02 -3.81991602e-02 -1.12879798e-01]
   [-1.46949748e-02 -1.70101389e-01  3.64428125e-02]]

  [[ 1.01830527e-01  1.28894329e-01  1.65396854e-01]
   [-1.31801441e-01 -1.25979751e-01 -1.72579691e-01]
   [-1.08802088e-01 -7.15568215e-02  1.67846933e-01]]

  [[ 1.11850075e-01 -1.08214673e-02  4.52158265e-02]
   [ 1.32615352e-02 -1.37648493e-01  1.70783758e-01]
   [ 4.86204587e-03  8.92304927e-02 -5.40204160e-02]]]


 [[[-1.45559549e-01  1.75284743e-01  1.13056228e-01]
   [ 1.55172618e-02 -1.78572848e-01  1.45121753e-01]
   [-1.07995614e-01  1.32856155e-02 -2.91718729e-02]]

  [[ 6.79991543e-02  1.06671408e-01 -2.56570634e-02]
   [ 1.02602476e-02  5.61184622e-02  1.34640455e-01]
   [ 3.32965367e-02  1.36100337e-01 -4.63791117e-02]]

  [[ 5.40006869e-02  1.68028578e-01  1.92186758e-02]
   [-7.92301819e-02 -1.54595345e-01  1.29194111e-01]
   [ 1.30985126e-01 -4.95647378e-02 -1.92142710e-01]]]


 [[[ 6.88930452e-02  4.38229628e-02 -7.47637749e-02]
   [-3.67822894e-03 -1.15200400e-01 -9.46477056e-02]
   [ 6.70265756e-04 -2.87401136e-02 -7.61194006e-02]]

  [[-4.48891819e-02  1.82095349e-01 -1.26562804e-01]
   [ 6.35678992e-02 -1.34067416e-01  6.42388826e-03]
   [ 6.02211468e-02 -1.26031429e-01  1.59797594e-01]]

  [[-1.10113412e-01 -6.99020997e-02  8.28907937e-02]
   [-9.77224261e-02  1.87562734e-01  1.21832609e-01]
   [ 1.43286332e-01 -7.19074830e-02 -1.19095124e-01]]]


 [[[-1.17977954e-01  1.28927618e-01 -7.27764443e-02]
   [ 3.74318138e-02 -2.08348930e-02  9.08360258e-02]
   [ 2.75218301e-02 -1.04259282e-01 -1.86309755e-01]]

  [[-6.92640468e-02 -3.90677117e-02  9.78386402e-02]
   [ 3.93228941e-02  1.14411093e-01 -1.87491372e-01]
   [-1.17995322e-01 -1.17948085e-01 -1.57659888e-01]]

  [[-1.21817663e-01  8.39062482e-02 -9.83663574e-02]
   [ 1.37255993e-02  1.57045513e-01 -3.94364111e-02]
   [ 1.29241675e-01 -1.30709022e-01  1.24908432e-01]]]


 [[[-1.44099472e-02 -9.03190672e-02 -1.07588291e-01]
   [ 1.45951599e-01 -5.57846166e-02 -2.67454684e-02]
   [ 1.66504458e-01  9.09045711e-02 -8.08750167e-02]]

  [[-7.11910129e-02 -1.37652576e-01  7.36697810e-03]
   [ 4.54457216e-02  1.64087027e-01  1.44407332e-01]
   [ 3.14361975e-02 -6.45405278e-02 -1.69188723e-01]]

  [[ 1.21312579e-02  1.43278673e-01 -1.27511606e-01]
   [-1.25938669e-01 -4.16933745e-02 -1.88281074e-01]
   [ 3.00851297e-02 -9.94688198e-02  5.89211173e-02]]]


 [[[-1.21469289e-01 -1.38406381e-01 -2.98331827e-02]
   [-8.48830044e-02  1.59814939e-01  2.53010765e-02]
   [-1.85055420e-01 -1.08954698e-01 -8.22474808e-02]]

  [[-1.04435824e-01  4.74766344e-02 -1.39863744e-01]
   [ 8.00046325e-02 -1.25218540e-01  1.80824012e-01]
   [ 1.35660008e-01 -1.82975024e-01  5.17374650e-03]]

  [[-6.37843236e-02  3.51481475e-02  1.27998173e-01]
   [-1.22627713e-01 -1.85965866e-01 -1.43514842e-01]
   [-3.35164331e-02  4.80576120e-02 -1.74486786e-01]]]


 [[[ 9.44136903e-02  1.61721513e-01  1.69337362e-01]
   [ 1.11800633e-01 -6.61104321e-02 -1.56381905e-01]
   [-1.89136222e-01 -1.62980020e-01  2.22406313e-02]]

  [[ 1.33374035e-01  6.82297051e-02 -1.12308346e-01]
   [-1.50688946e-01 -1.43540040e-01 -1.38565525e-01]
   [ 4.97956313e-02  9.89650711e-02 -6.35394678e-02]]

  [[-1.29216492e-01 -8.04672111e-03  2.16581188e-02]
   [-1.25993222e-01  1.62026003e-01 -7.64271691e-02]
   [ 1.11739151e-01  9.57291573e-02 -5.84396161e-02]]]


 [[[ 5.73633276e-02  8.50086585e-02  1.28257185e-01]
   [-9.05734226e-02  9.28696096e-02 -1.82106495e-01]
   [ 7.04320706e-03 -2.65570898e-02 -8.82008597e-02]]

  [[-9.61784497e-02 -1.54109582e-01  1.50781453e-01]
   [ 6.37467131e-02  1.58843756e-01  6.77637756e-02]
   [-9.51981023e-02  1.05017923e-01 -6.69797882e-02]]

  [[-9.08739343e-02  7.17056245e-02  7.59931430e-02]
   [ 4.58005741e-02  9.09213200e-02 -4.13423330e-02]
   [ 1.36810824e-01  2.79323701e-02 -5.16197346e-02]]]


 [[[-1.23421676e-01  6.37937710e-02 -1.57977611e-01]
   [ 6.80478215e-02 -1.24262534e-01 -1.42828956e-01]
   [-2.74397694e-02  1.53244715e-02 -3.07629500e-02]]

  [[-1.06590711e-01  4.80640642e-02 -7.43658021e-02]
   [-8.00881833e-02  1.61798988e-02 -1.25870198e-01]
   [ 5.31591661e-02 -4.00523916e-02 -5.61023839e-02]]

  [[-1.69453956e-02 -1.70709074e-01  3.80019136e-02]
   [-1.38274103e-01  2.56030019e-02  4.91770282e-02]
   [-1.63774058e-01 -2.75554024e-02  1.92433506e-01]]]


 [[[ 1.35245835e-02  6.21156255e-03 -1.63494125e-02]
   [ 6.58864947e-03  9.15213823e-02 -1.20504787e-02]
   [ 1.19562283e-01  2.16566436e-02  1.60293117e-01]]

  [[-1.64771542e-01 -1.31761983e-01  1.65930256e-01]
   [ 1.17297672e-01  1.49281323e-02  6.86330497e-02]
   [ 7.92388692e-02  1.42383054e-01 -2.89131291e-02]]

  [[ 1.60736993e-01  1.83531027e-02 -4.93093655e-02]
   [-3.86489183e-02 -1.65534526e-01  6.90296292e-02]
   [-5.76262586e-02 -1.84045091e-01 -7.31501952e-02]]]


 [[[ 6.64079264e-02  1.91861644e-01 -3.63334529e-02]
   [-2.04962064e-02 -1.49645030e-01 -1.11757167e-01]
   [-9.92663354e-02 -1.64039180e-01  2.87742224e-02]]

  [[ 5.21537140e-02 -3.76499631e-02  1.66099533e-01]
   [-1.87957600e-01 -6.13861121e-02  1.68148592e-01]
   [ 8.61620605e-02 -9.29568857e-02  9.00472660e-05]]

  [[-1.41450733e-01 -1.87482238e-01  1.15331411e-01]
   [ 8.74742195e-02 -1.79373935e-01  1.68365151e-01]
   [-4.85223643e-02  2.62084939e-02  9.95452330e-02]]]


 [[[ 3.42100486e-02  1.18343845e-01  1.71780899e-01]
   [-1.80151016e-02  9.99204256e-03  2.75662504e-02]
   [ 9.85916555e-02 -4.78518903e-02  1.66902468e-01]]

  [[-1.82991207e-01  2.00715698e-02 -3.59003991e-02]
   [ 1.21063836e-01  1.26032874e-01 -1.75404131e-01]
   [ 1.47086540e-02  1.77703902e-01  1.27777249e-01]]

  [[ 1.56711936e-01  1.57977998e-01 -2.38885731e-02]
   [ 1.78897813e-01  1.87309295e-01 -1.04379751e-01]
   [-1.87624060e-02  3.93677019e-02  1.20584955e-02]]]]

**************parse weight data******************
initializer info:
        name:      onnx::Conv_13
        data:
[ 0.16340801  0.02500708  0.05731801 -0.03522021  0.06846106  0.16195868
 -0.1477132  -0.02854403  0.1260686   0.12818363 -0.03738552  0.0509505
 -0.18715714 -0.17033531  0.04914879  0.05854415]
"""
